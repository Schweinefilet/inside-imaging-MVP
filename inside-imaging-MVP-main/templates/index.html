<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="dark">
  <title>Inside Imaging - Public</title>
  <link rel="stylesheet" href="/static/main.css">
</head>
<body>
  <div class="wrap">
    <!-- Loading status and spinner -->
    <div id="status" class="status"></div>
    <div id="spinner-overlay" class="spinner-overlay">
      <div class="spinner"></div>
    </div>

    <!-- Header with logo and nav -->
    <header class="header">
      <div class="logo-wrapper">
        <img src="/static/logo.png" alt="Inside Imaging Logo" class="logo">
        <span class="brand">Inside Imaging</span>
      </div>
      <nav class="nav">
        {% if session.get('user_id') %}
        <a href="{{ url_for('logout') }}">Log out</a>
        {% endif %}
      </nav>
    </header>

    <div class="layout">
      <!-- Sidebar for stats -->
      <aside class="sidebar">
        <h3>Statistics</h3>
        <ul class="stats">
          <li>Total reports: {{ stats.total }}</li>
          <li>Male patients: {{ stats.male }}</li>
          <li>Female patients: {{ stats.female }}</li>
          <li>Age 0–17: {{ stats['0-17'] }}</li>
          <li>Age 18–30: {{ stats['18-30'] }}</li>
          <li>Age 31–50: {{ stats['31-50'] }}</li>
          <li>Age 51–65: {{ stats['51-65'] }}</li>
          <li>Age 66+: {{ stats['66+'] }}</li>
        </ul>
      </aside>

      <!-- Main content -->
      <main class="main-content">
        <!-- Upload first -->
        <h2>Upload a report</h2>
        <form id="upform" method="post" action="/upload" enctype="multipart/form-data">
          <label class="visually-hidden" for="file">Choose file</label>
          <input id="file" type="file" name="file" accept=".pdf,.png,.jpg,.jpeg,.webp,.tif,.tiff,.bmp,.txt" required>
          <!-- Language selection -->
          <label class="language-label" for="language">Language:</label>
          <select id="language" name="language">
            {% for lang in languages %}
            <option value="{{ lang }}">{{ lang }}</option>
            {% endfor %}
          </select>
          <button type="submit">Upload & Convert</button>
        </form>

        <!-- Paste second -->
        <h2>Or paste text</h2>
        <form id="pasteform" method="post" action="/paste">
          <textarea id="text" name="text" rows="10" placeholder="Paste radiology text here"></textarea>
          <!-- Language selection for paste -->
          <label class="language-label" for="language2">Language:</label>
          <select id="language2" name="language">
            {% for lang in languages %}
            <option value="{{ lang }}">{{ lang }}</option>
            {% endfor %}
          </select>
          <button type="submit">Simplify</button>
        </form>
      </main>
    </div>
  </div>

  <script>
    // Helper to compose polite loading message
    function salutation(sex, name) {
      const title = sex === 'M' ? 'Mr.' : (sex === 'F' ? 'Ms.' : 'Patient');
      const who = (name && name.length > 1) ? name : 'Patient';
      return title + ' ' + who + ', please wait while your report is loading.';
    }
    // Show spinner overlay
    function showSpinner() {
      document.getElementById('spinner-overlay').style.display = 'flex';
    }
    // Hide spinner overlay
    function hideSpinner() {
      document.getElementById('spinner-overlay').style.display = 'none';
    }
    // Intercept paste form submission to display loading message and spinner
    const pasteForm = document.getElementById('pasteform');
    pasteForm.addEventListener('submit', function (e) {
      const raw = document.getElementById('text').value || '';
      // Guess name/sex for loading salutation
      let n = '', s = '';
      const mName = raw.match(/\bNAME\b[:\s\-–]*([A-Z][A-Za-z' .\-]+)/i);
      if (mName) n = mName[1].trim();
      const mSex = raw.match(/\bSEX\b[:\s\-–]*([MF]|Male|Female)/i);
      if (mSex) {
        const v = mSex[1].toLowerCase();
        s = v.startsWith('m') ? 'M' : (v.startsWith('f') ? 'F' : '');
      }
      document.getElementById('status').textContent = salutation(s, n);
      showSpinner();
    });
    // Show spinner for uploads when the form is submitted
    const upForm = document.getElementById('upform');
    upForm.addEventListener('submit', function () {
      // Extract current patient name/sex if available (will be empty on index)
      const n = document.getElementById('pName').textContent || '';
      const s = document.getElementById('pSex').textContent || '';
      document.getElementById('status').textContent = salutation(s, n || 'Patient');
      showSpinner();
    });
  </script>
</body>
</html>