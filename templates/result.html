<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  <title>Result - Inside Imaging</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='logo.png') }}">

  <!-- Pre-paint theme to avoid flash -->
  <script>
  (function(){
    try{
      var t = localStorage.getItem('theme');
      var preferLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
      var useLight = t ? (t === 'light') : preferLight;
      if(useLight) document.documentElement.classList.add('light');
    }catch(e){}
  })();
  </script>

  <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='loader.css') }}">

  <style>
    /* Theme tokens */
    :root{
      --bg:#0b0c0f;
      --text:#f5f6f8;
      --panel:#151821;
      --panel-2:#0f1117;
      --border:#2a2f3a;
      --muted:#9aa3b2;
      --mint:#22c55e;
      --shadow:0 6px 24px rgba(0,0,0,.3);
      --link:#93c5fd;
      --body-fill:#e8eef2;
    }
    .light{
      --bg:#ffffff;
      --text:#0a0a0b;
      --panel:#f6f7f9;
      --panel-2:#ffffff;
      --border:#d0d7de;
      --muted:#495057;
      --mint:#22c55e;
      --shadow:0 2px 8px rgba(0,0,0,.08);
      --link:#1d4ed8;
      --body-fill:#1a1a1a;
    }

  /* Body silhouette */
  .body-svg{display:block;margin:1rem auto;width:100%;height:100%;max-width:200px}
  .body-base use{fill:var(--body-fill);stroke:var(--border);stroke-width:0.5}
  .body-outline use{fill:none;stroke:color-mix(in oklab, var(--border) 45%, #000);stroke-width:1.6}
  .region-band{fill:transparent;opacity:1;transition:fill .2s ease, opacity .2s ease, stroke .2s ease}
  .region-band.highlight{fill:color-mix(in srgb, var(--mint) 80%, #ffffff 20%);opacity:.98;stroke:color-mix(in oklab, var(--mint) 70%, #0f766e);stroke-width:2.2}
  .light .region-band.highlight{fill:color-mix(in srgb, var(--mint) 80%, #000000 20%);stroke-width:2.6}


    /* Base: keep your CSS backgrounds; only remove default margins to kill seam */
    html, body { margin:0; color:var(--text); }
    a{ color:var(--link); }

    /* Avoid top margin collapse that looks like a seam under the navbar */
    .content > :first-child { margin-top: 0; }

    /* Light-mode readability without touching layout or backgrounds */
    .light .report,
    .light .report *:not(strong.negative):not(strong.positive):not(.ii-neg):not(.ii-pos),
    .light .patient-card,
    .light .patient-card *,
    .light details,
    .light details *,
    .light pre,
    .light code { color: var(--text) !important; }

    .light .simple-output strong.negative { color:#b91c1c !important; }
    .light .simple-output strong.positive { color:#166534 !important; }
    
    /* Preserve highlight colors in light mode */
    .light .ii-neg,
    .light .ii-neg * { color:#dc2626 !important; }
    .light .ii-pos,
    .light .ii-pos * { color:#16a34a !important; }
    .light .ii-text { color: var(--text) !important; }

    /* Components */
    .diagram-container{
      position:relative; width:200px; height:500px; margin:1rem auto;
      background-color:var(--panel-2); border-radius:10px; box-shadow:var(--shadow);
    }

    .patient-card{ margin-bottom:2rem; }
    .stat-badges{ display:flex; gap:.5rem; flex-wrap:wrap; margin:.5rem 0 1rem; }
    .badge{ border:1px solid var(--border); background:var(--panel); border-radius:10px; padding:.35rem .6rem; font-size:.85rem; }
    .stats-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:.75rem; }
    .stat-card{ background:var(--panel); border:1px solid var(--border); border-radius:10px; padding:.7rem .8rem; }
    .stat-card .label{ color:var(--muted); font-size:.8rem; display:block; }
    .stat-card .value{ font-weight:700; }

    .simple-output ul{ margin:.25rem 0 0; padding-left:1.1rem; }
    .simple-output li{ margin:.2rem 0; }
    .simple-output strong.negative{ color:#ff6b6b; cursor:help; position:relative; }
    .simple-output strong.positive{ color:#4cc96c; }
    .simple-output [data-def]{ text-decoration:underline dotted; cursor:help; }

    /* Tooltip */
    .def-tooltip{
      position:fixed; z-index:9998; background:var(--panel); color:var(--text);
      border:1px solid var(--border); border-radius:10px; padding:.5rem .6rem; box-shadow:var(--shadow);
      max-width:260px; font-size:.9rem; line-height:1.2; transform:translate(-50%,-100%); pointer-events:none;
    }
    .def-tooltip.hidden{ display:none; }
    .def-tooltip::after{
      content:""; position:absolute; left:50%; bottom:-8px; transform:translateX(-50%);
      width:0; height:0; border-left:8px solid transparent; border-right:8px solid transparent; border-top:8px solid var(--panel);
    }

    /* Brain summary diagrams */
    .brain-visual-section{
      margin:2rem 0;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:1.5rem;
      box-shadow:var(--shadow);
    }
    .brain-visual-section h2{margin-top:0; color:var(--mint);}
    .brain-summary{margin:0 0 1rem; color:var(--muted);}
    .brain-diagrams{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(180px,1fr));
      gap:1.5rem;
      margin-bottom:1rem;
    }
    .brain-view{
      background:var(--panel-2);
      border:1px solid var(--border);
      border-radius:12px;
      padding:1.2rem;
      display:flex;
      flex-direction:column;
      gap:0.75rem;
      align-items:center;
      box-shadow:var(--shadow);
      text-align:center;
      margin:0;
    }
    .brain-view figcaption{font-size:0.9rem; font-weight:600; color:var(--text); margin:0;}
    .brain-svg{width:100%; height:auto; max-width:200px; filter:drop-shadow(0 2px 4px rgba(0,0,0,0.1));}
    .brain-outline{stroke:rgb(70,110,125); stroke-width:2.5;}
    .brain-highlight{stroke:rgb(180,50,40); stroke-width:1.5;}
    .light .brain-outline{stroke:rgb(90,130,145);}
    .light .brain-highlight{stroke:rgb(200,60,50);}
    .brain-notes{margin:1rem 0 0; padding-left:1.3rem; color:var(--muted); list-style-type:disc;}
    .brain-notes li{margin:0.4rem 0; line-height:1.5;}

    /* Modal */
    .organ-modal{ position:fixed; inset:0; z-index:9997; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.45); backdrop-filter:saturate(120%) blur(2px); }
    .organ-modal.show{ display:flex; }
    .organ-card{ background:var(--panel); color:var(--text); border:1px solid var(--border);
      border-radius:14px; padding:16px 18px; box-shadow:var(--shadow); width:min(92vw,680px); }
    .organ-card header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem; }
    .organ-card button{ background:transparent; color:inherit; border:1px solid var(--border); border-radius:8px; padding:.35rem .6rem; cursor:pointer; }
    .organ-link{ text-decoration:underline dotted; cursor:pointer; }

    /* Theme switch */
    .theme-switch{ display:inline-grid; grid-template-rows:auto auto; gap:6px; user-select:none; cursor:pointer; }
    .theme-row{ display:grid; grid-template-columns:auto auto auto; align-items:center; gap:8px 10px; min-height:28px; }
    .theme-icon{ font-size:18px; line-height:1; }
    .theme-switch-input{ position:absolute; opacity:0; width:1px; height:1px; }
    .theme-switch-track{
      position:relative; display:inline-block; width:56px; height:28px; border-radius:999px;
      background:var(--panel); border:1px solid var(--border); box-shadow:var(--shadow); vertical-align:middle;
    }
    .theme-switch-track::after{
      content:""; position:absolute; left:2px; top:50%; width:24px; height:24px; border-radius:50%;
      background:var(--bg); box-shadow:0 2px 6px rgba(0,0,0,.25); transform:translate(0,-50%); transition:transform .2s ease;
    }
    .theme-switch-input:checked + .theme-switch-track::after{ transform:translate(28px,-50%); }
    .theme-switch-text{ text-align:center; font-size:.9rem; color:var(--muted); }
    .theme-row .theme-icon:first-of-type{ opacity:1; }
    .theme-row .theme-icon:last-of-type{ opacity:.5; }
    .light .theme-row .theme-icon:first-of-type{ opacity:.5; }
    .light .theme-row .theme-icon:last-of-type{ opacity:1; }
    .theme-switch-input:focus-visible + .theme-switch-track{ outline:2px solid var(--mint); outline-offset:2px; }
  </style>
</head>

<body>
<div class="page-wrapper">
  <header class="navbar">
    <div class="navbar-brand">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="Inside Imaging logo">
      <span class="brand-name">Inside Imaging</span>
    </div>
    <nav class="nav-links">
      <a href="{{ url_for('index') }}">Dashboard</a>
      <a href="{{ url_for('projects') }}">Projects</a>
      <a href="{{ url_for('report_status') }}">Statistics</a>
      <a href="{{ url_for('payment') }}">Payment</a>
      <a href="{{ url_for('help_page') }}">Help</a>
    </nav>
    <div class="nav-auth">
      <label class="theme-switch" aria-label="Toggle theme">
        <span class="theme-row">
          <span class="theme-icon" aria-hidden="true">üåô</span>
          <input id="theme-toggle" class="theme-switch-input" type="checkbox" role="switch" aria-checked="false">
          <span class="theme-switch-track" aria-hidden="true"></span>
          <span class="theme-icon" aria-hidden="true">‚òÄÔ∏è</span>
        </span>
        <span id="theme-label" class="theme-switch-text">Dark mode</span>
      </label>

      {% if session.get('username') %}
        <div class="user-menu">
          <button class="user-menu-toggle" type="button" aria-expanded="false">
            <span class="user-name" aria-live="polite">{{ session.get('username') }}</span>
            <span class="user-caret" aria-hidden="true">‚ñæ</span>
          </button>
          <div class="user-menu-dropdown" role="menu" hidden>
            <a href="{{ url_for('profile') }}" role="menuitem">Profile</a>
            <a href="{{ url_for('logout') }}" role="menuitem">Log Out</a>
          </div>
        </div>
      {% else %}
        <a href="{{ url_for('login') }}" class="login-button">Log In</a>
        <a href="{{ url_for('signup') }}" class="signup-button">Sign Up</a>
      {% endif %}
    </div>
  </header>

  <main class="content">
    <h1>Report Summary</h1>

    <div class="patient-card">
      <div><span class="lbl">Hospital</span><strong>{{ patient.hospital|default('', true) }}</strong></div>
      <div><span class="lbl">Study</span><strong>{{ patient.study|default('Unknown', true) }}</strong></div>
      <div><span class="lbl">Name</span><strong>{{ patient.name|default('', true) }}</strong></div>
      <div><span class="lbl">Sex</span><strong>{{ patient.sex|default('', true) }}</strong></div>
      <div><span class="lbl">Age</span><strong>{{ patient.age|default('', true) }}</strong></div>
      <div><span class="lbl">Date</span><strong>{{ patient.date|default('', true) }}</strong></div>
    </div>

    <section>
      <h2>Body Region Highlight</h2>
      <div id="diagram-container" class="diagram-container" data-organ="{{ patient.study|default('', true)|lower }}"></div>
    </section>

    {% if diagnosis and diagnosis.has_abnormality and diagnosis.organ == 'brain' %}
    <section class="brain-visual-section">
      <h2>Brain Visualization</h2>
      <p class="brain-summary">A simplified diagram showing the approximate location of key findings mentioned in the report. This is for illustrative purposes only.</p>
      <div class="brain-diagrams">
        <figure class="brain-view">
          <svg class="brain-svg" viewBox="0 0 240 240" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <radialGradient id="brainGrad" cx="50%" cy="50%">
                <stop offset="0%" style="stop-color:rgb(190,220,230);stop-opacity:1" />
                <stop offset="100%" style="stop-color:rgb(140,180,195);stop-opacity:1" />
              </radialGradient>
            </defs>
            <!-- Brain outline (axial/top view) -->
            <ellipse cx="120" cy="120" rx="85" ry="90" class="brain-outline" fill="url(#brainGrad)"/>
            <!-- Longitudinal fissure -->
            <path d="M120,30 Q120,60 120,120 Q120,180 120,210" stroke="rgb(100,140,155)" stroke-width="2.5" fill="none"/>
            <!-- Left hemisphere sulci -->
            <path d="M60,80 Q50,90 45,105" stroke="rgb(100,140,155)" stroke-width="1.2" fill="none" opacity="0.6"/>
            <path d="M50,115 Q45,125 42,140" stroke="rgb(100,140,155)" stroke-width="1.2" fill="none" opacity="0.6"/>
            <path d="M70,60 Q65,70 60,85" stroke="rgb(100,140,155)" stroke-width="1.2" fill="none" opacity="0.6"/>
            <!-- Right hemisphere sulci -->
            <path d="M180,80 Q190,90 195,105" stroke="rgb(100,140,155)" stroke-width="1.2" fill="none" opacity="0.6"/>
            <path d="M190,115 Q195,125 198,140" stroke="rgb(100,140,155)" stroke-width="1.2" fill="none" opacity="0.6"/>
            <path d="M170,60 Q175,70 180,85" stroke="rgb(100,140,155)" stroke-width="1.2" fill="none" opacity="0.6"/>
            <!-- Lesion in right frontoparietal region -->
            <ellipse cx="145" cy="95" rx="18" ry="22" class="brain-highlight" fill="#e74c3c" opacity="0.85"/>
          </svg>
          <figcaption>Top View (Axial)</figcaption>
        </figure>
        <figure class="brain-view">
          <svg class="brain-svg" viewBox="0 0 240 240" xmlns="http://www.w3.org/2000/svg">
            <!-- Brain outline (sagittal/side view) -->
            <path d="M60,120 Q60,50 100,35 Q140,50 160,70 Q175,90 178,120 Q175,150 165,175 Q150,195 120,205 Q90,200 70,175 Q60,150 60,120" 
                  class="brain-outline" fill="url(#brainGrad)"/>
            <!-- Cerebellum hint -->
            <ellipse cx="75" cy="185" rx="25" ry="20" fill="rgb(160,195,210)" opacity="0.8"/>
            <!-- Sulci -->
            <path d="M100,50 Q105,60 108,75" stroke="rgb(100,140,155)" stroke-width="1.2" fill="none" opacity="0.6"/>
            <path d="M130,60 Q135,75 138,95" stroke="rgb(100,140,155)" stroke-width="1.2" fill="none" opacity="0.6"/>
            <path d="M145,85 Q150,100 152,120" stroke="rgb(100,140,155)" stroke-width="1.2" fill="none" opacity="0.6"/>
            <!-- Lesion -->
            <ellipse cx="135" cy="90" rx="16" ry="20" class="brain-highlight" fill="#e74c3c" opacity="0.85"/>
          </svg>
          <figcaption>Side View (Sagittal)</figcaption>
        </figure>
        <figure class="brain-view">
          <svg class="brain-svg" viewBox="0 0 240 240" xmlns="http://www.w3.org/2000/svg">
            <!-- Brain outline (coronal/front view) -->
            <path d="M50,120 Q50,60 80,45 Q110,40 120,40 Q130,40 160,45 Q190,60 190,120 Q185,150 170,175 Q150,195 120,200 Q90,195 70,175 Q55,150 50,120" 
                  class="brain-outline" fill="url(#brainGrad)"/>
            <!-- Longitudinal fissure -->
            <path d="M120,40 L120,120" stroke="rgb(100,140,155)" stroke-width="2.5" fill="none"/>
            <!-- Left hemisphere sulci -->
            <path d="M75,80 Q70,95 68,110" stroke="rgb(100,140,155)" stroke-width="1.2" fill="none" opacity="0.6"/>
            <path d="M85,65 Q80,80 78,95" stroke="rgb(100,140,155)" stroke-width="1.2" fill="none" opacity="0.6"/>
            <!-- Right hemisphere sulci -->
            <path d="M165,80 Q170,95 172,110" stroke="rgb(100,140,155)" stroke-width="1.2" fill="none" opacity="0.6"/>
            <path d="M155,65 Q160,80 162,95" stroke="rgb(100,140,155)" stroke-width="1.2" fill="none" opacity="0.6"/>
            <!-- Lesion in right hemisphere -->
            <ellipse cx="155" cy="85" rx="17" ry="20" class="brain-highlight" fill="#e74c3c" opacity="0.85"/>
          </svg>
          <figcaption>Front View (Coronal)</figcaption>
        </figure>
      </div>
      <ul class="brain-notes">
        <li>The red area indicates a lesion consistent with the findings mentioned in the report.</li>
        <li>Diagram shows approximate location for illustrative purposes only.</li>
      </ul>
    </section>
    {% endif %}

    {% if language and language != 'English' %}
      <p class="lang-warning">Translation into {{ language }} is not yet supported. Displaying English.</p>
    {% endif %}

    <section class="report-section">
      <h2>Report Statistics</h2>
      <div class="stat-badges">
        <span class="badge">Words: {{ structured.word_count|default(report_stats.words, true) }}</span>
        <span class="badge">Sentences: {{ structured.sentence_count|default(report_stats.sentences, true) }}</span>
        <span class="badge positive">Highlighted positive: {{ structured.highlights_positive|default(report_stats.highlights_positive, true) }}</span>
        <span class="badge negative">Highlighted negative: {{ structured.highlights_negative|default(report_stats.highlights_negative, true) }}</span>
      </div>
      <div class="stats-grid">
        <div class="stat-card"><span class="label">Comparison</span><span class="value">{{ structured.comparison or 'None' }}</span></div>
        <div class="stat-card"><span class="label">Oral contrast</span><span class="value">{{ structured.oral_contrast or 'Not stated' }}</span></div>
      </div>
    </section>

    <section class="report-actions" style="margin:1rem 0;">
      <form method="post" action="{{ url_for('download_pdf') }}">
        <textarea name="structured" hidden>{{ structured|tojson }}</textarea>
        <textarea name="patient" hidden>{{ patient|tojson }}</textarea>
        <button type="submit" class="btn">Download PDF</button>
      </form>
    </section>

    <div class="report">
      <section>
        <h3>Reason for the Scan</h3>
        <p class="simple-output">{{ structured.reason|default('', true)|safe }}</p>
      </section>
      <section>
        <h3>Procedure Details</h3>
        <p class="simple-output">{{ structured.technique|default('', true)|safe }}</p>
      </section>
      <section class="important-findings">
        <h3>Important Findings</h3>
        <div class="simple-output">{{ structured.findings|default('', true)|safe }}</div>
      </section>
      <section>
        <h3>Conclusion</h3>
        <div class="simple-output">{{ structured.conclusion|default('', true)|safe }}</div>
      </section>
      {% if structured.concern %}
      <section class="warn">
        <h3>Note of Concern</h3>
        <p class="simple-output">{{ structured.concern|safe }}</p>
      </section>
      {% endif %}
    </div>

    <details>
      <summary>Extracted text</summary>
      <pre>{{ extracted }}</pre>
    </details>

    <p><a href="{{ url_for('index') }}">&larr; Back to Dashboard</a></p>
  </main>

  {% include '_footer.html' %}
</div>

<div id="def-tooltip" class="def-tooltip hidden" role="tooltip" aria-hidden="true"></div>

<div id="organ-modal" class="organ-modal" aria-hidden="true">
  <div class="organ-card" role="dialog" aria-modal="true" aria-labelledby="organ-title">
    <header>
      <h3 id="organ-title">Organ</h3>
      <button type="button" id="organ-close">Close</button>
    </header>
    <div id="organ-content">
      <p>Viewer placeholder for <strong id="organ-name"></strong>.</p>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function(){
    /* Theme toggle that switches class and persists */
    var toggle = document.getElementById('theme-toggle');
    var label = document.getElementById('theme-label');
    var isLight = document.documentElement.classList.contains('light');
    if(toggle && label){
      toggle.checked = isLight;
      label.textContent = isLight ? 'Light mode' : 'Dark mode';
      toggle.setAttribute('aria-checked', String(isLight));
      toggle.addEventListener('change', function(){
        var nowLight = toggle.checked;
        document.documentElement.classList.toggle('light', nowLight);
        localStorage.setItem('theme', nowLight ? 'light' : 'dark');
        label.textContent = nowLight ? 'Light mode' : 'Dark mode';
        toggle.setAttribute('aria-checked', String(nowLight));
      });
    }

    /* Diagram highlight: SVG silhouette + clipped bands */
    var container = document.getElementById('diagram-container');
    function buildBodySVG(el){
    el.innerHTML = `
    <svg class="body-svg" viewBox="0 0 200 500" role="img" aria-labelledby="bodyTitle">
      <title id="bodyTitle">Body region diagram</title>

      <defs>
        <!-- primitives -->
        <circle id="h"  cx="100" cy="58"  r="36"/>
  <rect   id="t"  x="58"  y="100" width="84" height="190" rx="22" ry="22"/>
  <rect   id="la" x="32"  y="130" width="28" height="150" rx="12" ry="12"/>
  <rect   id="ra" x="140" y="130" width="28" height="150" rx="12" ry="12"/>
  <rect   id="ll" x="66"  y="290" width="32" height="164" rx="6"  ry="6"/>
  <rect   id="rl" x="102" y="290" width="32" height="164" rx="6"  ry="6"/>

        <!-- region clips -->
        <clipPath id="clipHead"><use href="#h"/></clipPath>
        <clipPath id="clipTorso"><use href="#t"/></clipPath>
        <clipPath id="clipPelvis"><use href="#ll"/><use href="#rl"/></clipPath>
      </defs>

      <!-- solid silhouette under bands -->
      <g class="body-base" aria-hidden="true">
  <use href="#h"/><use href="#t"/><use href="#la"/><use href="#ra"/><use href="#ll"/><use href="#rl"/>
      </g>

      <!-- bands, each clipped to its region -->
      <g clip-path="url(#clipHead)">
        <rect class="region-band head" x="0" y="0" width="200" height="500"/>
      </g>
      <g clip-path="url(#clipTorso)">
        <!-- full torso (for single ‚Äúbody‚Äù highlight) -->
        <rect class="region-band torso"   x="0" y="0"   width="200" height="500"/>
        <!-- keep granular bands for CAP/AP -->
        <rect class="region-band chest"   x="0" y="90" width="220" height="135"/>
        <rect class="region-band abdomen" x="0" y="240" width="200" height="110"/>
      </g>
      <g clip-path="url(#clipPelvis)">
        <rect class="region-band pelvis" x="0" y="0" width="200" height="500"/>
      </g>

      <!-- outline on top -->
      <g class="body-outline" aria-hidden="true">
  <use href="#h"/><use href="#t"/><use href="#la"/><use href="#ra"/><use href="#ll"/><use href="#rl"/>
      </g>
    </svg>`;
    }

    if(container){
      buildBodySVG(container);
      // Robust region picker: supports "AP", "A/P", "CAP", full words, organs
      var text = (container.dataset.organ || '').toLowerCase();
      function hits(rx){ return (text.match(rx) || []).length; }

      var scores = {
        head:    hits(/\b(brain|head|skull)\b/g),
        chest:   hits(/\b(chest|thorax|lung|heart)\b/g) + hits(/\bcap\b|chest\s*abd(?:omen)?\s*pelvis/g),
        abdomen: hits(/\b(abdomen|abdominal|liver|kidney|renal|pancreas|stomach|spleen|gallbladder)\b/g)
                + hits(/\ba\/p\b|\babd(?:omen)?\s*pelvis\b/g),
        pelvis:  hits(/\b(pelvis|pelvic|bladder|prostate|ovary|uterus)\b/g)
                + hits(/\ba\/p\b|\babd(?:omen)?\s*pelvis\b/g)
      };

      var ap  = /\ba\/p\b|\babd(?:omen)?\s*pelvis\b/.test(text);
      var cap = /\bcap\b|chest\s*abd(?:omen)?\s*pelvis/.test(text);
      var max = Math.max(scores.head, scores.chest, scores.abdomen, scores.pelvis);

      // If exactly one of chest/abdomen is referenced (not CAP/AP), fill full torso
      var torsoSingle = !ap && !cap && (Boolean(scores.chest) !== Boolean(scores.abdomen));
      if(torsoSingle){
        container.querySelector('.region-band.torso')?.classList.add('highlight');
      } else {
        ['head','chest','abdomen','pelvis'].forEach(function(r){
          var node = container.querySelector('.region-band.'+r);
          if(!node) return;
          var on = ap ? (r==='abdomen' || r==='pelvis')
                : cap ? (r==='chest' || r==='abdomen' || r==='pelvis')
                : scores[r] === max && max > 0;
          if(on) node.classList.add('highlight');
        });
        if(!container.querySelector('.region-band.highlight')){
          container.querySelector('.region-band.chest')?.classList.add('highlight');
        }
      }
    }

    /* Dynamic brain lesion positioning */
    function parseBrainLesion() {
      var conclusion = '{{ structured.conclusion|default("", true)|safe }}'.toLowerCase().replace(/<[^>]+>/g, ' ');
      var findings = '{{ structured.findings|default("", true)|safe }}'.toLowerCase().replace(/<[^>]+>/g, ' ');
      var combinedText = conclusion + ' ' + findings;
      
      // Location mapping: [axial_x, axial_y, sagittal_x, sagittal_y, coronal_x, coronal_y]
      var locationMap = {
        'right frontoparietal': [145, 95, 135, 90, 155, 85],
        'left frontoparietal': [95, 95, 135, 90, 85, 85],
        'right frontal': [140, 85, 125, 75, 150, 75],
        'left frontal': [100, 85, 125, 75, 90, 75],
        'right parietal': [150, 100, 140, 95, 160, 90],
        'left parietal': [90, 100, 140, 95, 80, 90],
        'right temporal': [155, 115, 145, 110, 165, 105],
        'left temporal': [85, 115, 145, 110, 75, 105],
        'right occipital': [155, 125, 155, 130, 165, 120],
        'left occipital': [85, 125, 155, 130, 75, 120],
        'sphenoid wing': [130, 105, 120, 100, 135, 100],
        'greater sphenoid wing': [135, 105, 120, 100, 140, 100],
        'cerebellum': [120, 145, 80, 165, 120, 165],
        'brainstem': [120, 155, 90, 175, 120, 175],
        'thalamus': [120, 110, 115, 110, 120, 110],
        'basal ganglia': [115, 110, 115, 105, 115, 105]
      };
      
      // Parse size (e.g., "5.4 x 5.6 x 6.7 cm" or "measures 2.5 cm")
      var sizeMatch = combinedText.match(/(\d+\.?\d*)\s*x\s*(\d+\.?\d*)\s*x\s*(\d+\.?\d*)\s*cm|measures?\s+(\d+\.?\d*)\s*cm/i);
      var avgSize = 18; // default radius
      if (sizeMatch) {
        if (sizeMatch[1]) {
          var dims = [parseFloat(sizeMatch[1]), parseFloat(sizeMatch[2]), parseFloat(sizeMatch[3])];
          avgSize = Math.min(30, Math.max(10, (dims[0] + dims[1] + dims[2]) / 3 * 3)); // scale to pixels
        } else if (sizeMatch[4]) {
          avgSize = Math.min(30, Math.max(10, parseFloat(sizeMatch[4]) * 3));
        }
      }
      
      // Find best location match
      var bestMatch = null;
      var bestLength = 0;
      for (var loc in locationMap) {
        if (combinedText.indexOf(loc) !== -1 && loc.length > bestLength) {
          bestMatch = loc;
          bestLength = loc.length;
        }
      }
      
      return {
        location: bestMatch,
        coords: bestMatch ? locationMap[bestMatch] : [145, 95, 135, 90, 155, 85],
        size: avgSize,
        found: !!bestMatch
      };
    }
    
    /* Update brain diagrams with parsed lesion data */
    function updateBrainDiagrams() {
      var lesionData = parseBrainLesion();
      var diagrams = document.querySelectorAll('.brain-view svg');
      
      if (diagrams.length === 3) {
        // Axial (top) view
        var axialLesion = diagrams[0].querySelector('.brain-highlight');
        if (axialLesion) {
          axialLesion.setAttribute('cx', lesionData.coords[0]);
          axialLesion.setAttribute('cy', lesionData.coords[1]);
          axialLesion.setAttribute('rx', lesionData.size);
          axialLesion.setAttribute('ry', lesionData.size * 1.2);
        }
        
        // Sagittal (side) view
        var sagittalLesion = diagrams[1].querySelector('.brain-highlight');
        if (sagittalLesion) {
          sagittalLesion.setAttribute('cx', lesionData.coords[2]);
          sagittalLesion.setAttribute('cy', lesionData.coords[3]);
          sagittalLesion.setAttribute('rx', lesionData.size * 0.9);
          sagittalLesion.setAttribute('ry', lesionData.size * 1.1);
        }
        
        // Coronal (front) view
        var coronalLesion = diagrams[2].querySelector('.brain-highlight');
        if (coronalLesion) {
          coronalLesion.setAttribute('cx', lesionData.coords[4]);
          coronalLesion.setAttribute('cy', lesionData.coords[5]);
          coronalLesion.setAttribute('rx', lesionData.size * 0.95);
          coronalLesion.setAttribute('ry', lesionData.size * 1.1);
        }
        
        // Update notes if location was found
        if (lesionData.found) {
          var notesList = document.querySelector('.brain-notes');
          if (notesList) {
            var firstNote = notesList.querySelector('li');
            if (firstNote) {
              firstNote.textContent = 'The red area indicates a lesion in the ' + lesionData.location + ' region, as described in the conclusion.';
            }
          }
        }
      }
    }
    
    // Run brain diagram updates after DOM is ready
    if (document.querySelector('.brain-visual-section')) {
      updateBrainDiagrams();
    }

    /* Term definitions */
    var TERM_DEFS = {
      "interhemispheric fissure":"deep groove between the two brain halves",
      "cortical sulcation":"normal folds and grooves on the brain surface",
      "grey-white matter differentiation":"normal contrast between outer (grey) and inner (white) layers",
      "cerebral ventricles":"fluid spaces inside the brain",
      "ventricles":"fluid spaces inside the brain",
      "basal cisterns":"fluid spaces at the base of the brain",
      "posterior fossa":"back lower part of the skull that holds cerebellum and brainstem",
      "brain stem":"part that connects the brain to the spinal cord",
      "brainstem":"part that connects the brain to the spinal cord",
      "sella":"small bone pocket under the brain that holds the pituitary",
      "pituitary":"small hormone gland under the brain",
      "orbits":"eye sockets",
      "paranasal sinuses":"air pockets in the face",
      "sinuses":"air pockets in the face",
      "dural venous sinuses":"large veins that drain blood from the brain",
      "flow voids":"MRI signs of fast-moving blood",
      "craniocervical junction":"where the skull meets the neck",
      "intracranial space-occupying lesion":"a mass inside the skull",
      "space-occupying lesion":"a mass inside the skull"
    };
    function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
    function annotateSimpleOutputTerms(){
      var roots = document.querySelectorAll('.simple-output');
      if(!roots.length) return;
      var terms = Object.keys(TERM_DEFS);
      if(!terms.length) return;
      var pattern = '\\b(' + terms.map(escapeRegExp).join('|') + ')\\b';
      var rxCheck = new RegExp(pattern,'i');
      var rxAll = new RegExp(pattern,'gi');
      roots.forEach(function(root){
        var walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, {
          acceptNode:function(node){
            if(!node.nodeValue) return NodeFilter.FILTER_REJECT;
            rxCheck.lastIndex = 0;
            if(!rxCheck.test(node.nodeValue)) return NodeFilter.FILTER_REJECT;
            if(node.parentElement && node.parentElement.closest('[data-def]')) return NodeFilter.FILTER_REJECT;
            return NodeFilter.FILTER_ACCEPT;
          }
        });
        var toWrap = [];
        while(walker.nextNode()) toWrap.push(walker.currentNode);
        toWrap.forEach(function(textNode){
          var text = textNode.nodeValue;
          var frag = document.createDocumentFragment();
          var last = 0;
          text.replace(rxAll, function(match, _g1, offset){
            if(offset > last) frag.appendChild(document.createTextNode(text.slice(last, offset)));
            var span = document.createElement('span');
            span.textContent = match;
            span.setAttribute('data-def', TERM_DEFS[match.toLowerCase()] || 'Definition not available.');
            frag.appendChild(span);
            last = offset + match.length;
            return match;
          });
          if(last < text.length) frag.appendChild(document.createTextNode(text.slice(last)));
          if(textNode.parentNode) textNode.parentNode.replaceChild(frag, textNode);
        });
      });
    }

    /* Tooltip */
    var tooltip = document.getElementById('def-tooltip');
    function showTip(text, x, y){
      tooltip.textContent = text;
      tooltip.style.left = x + 'px';
      tooltip.style.top = y + 'px';
      tooltip.classList.remove('hidden');
      tooltip.setAttribute('aria-hidden','false');
    }
    function hideTip(){
      tooltip.classList.add('hidden');
      tooltip.setAttribute('aria-hidden','true');
    }
    document.body.addEventListener('mousemove', function(e){
      if(!tooltip.classList.contains('hidden')){
        tooltip.style.left = e.clientX + 'px';
        tooltip.style.top = (e.clientY - 14) + 'px';
      }
    }, {passive:true});
    document.addEventListener('mouseover', function(e){
      var target = e.target.closest('.simple-output [data-def]');
      if(target){
        var def = target.getAttribute('data-def') || 'Definition not available.';
        var rect = target.getBoundingClientRect();
        showTip(def, rect.left + (rect.width/2), rect.top - 6);
      }
    }, {passive:true});
    document.addEventListener('mouseout', function(e){
      var target = e.target.closest('.simple-output [data-def]');
      if(target) hideTip();
    }, {passive:true});

    annotateSimpleOutputTerms();

    /* Modal controls */
    var organModal = document.getElementById('organ-modal');
    var organClose = document.getElementById('organ-close');
    var organName = document.getElementById('organ-name');
    function openOrgan(org){
      organName.textContent = org;
      organModal.classList.add('show');
      organModal.setAttribute('aria-hidden','false');
      window.dispatchEvent(new CustomEvent('organ:open', { detail:{ organ:org } }));
    }
    function closeOrgan(){
      organModal.classList.remove('show');
      organModal.setAttribute('aria-hidden','true');
    }
    if(organClose) organClose.addEventListener('click', closeOrgan);
    organModal.addEventListener('click', function(e){ if(e.target === organModal) closeOrgan(); });
    document.addEventListener('click', function(e){
      var o = e.target.closest('.organ-link');
      if(o){
        var key = o.getAttribute('data-organ') || o.textContent.trim().toLowerCase();
        openOrgan(key);
      }
    });
  });
</script>

<script src="{{ url_for('static', filename='theme.js') }}"></script>
<script src="{{ url_for('static', filename='loader.js') }}"></script>
</body>
</html>
