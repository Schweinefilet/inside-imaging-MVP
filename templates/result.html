<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  <title>Result - Inside Imaging</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='logo.png') }}">

  <!-- Pre-paint theme to avoid flash -->
  <script>
  (function(){
    try{
      var t = localStorage.getItem('theme');
      var preferLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
      var useLight = t ? (t === 'light') : preferLight;
      if(useLight) document.documentElement.classList.add('light');
    }catch(e){}
  })();
  </script>

  <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='loader.css') }}">

  <style>
    /* Theme tokens */
    :root{
      --bg:#0b0c0f;
      --text:#f5f6f8;
      --panel:#151821;
      --panel-2:#0f1117;
      --border:#2a2f3a;
      --muted:#9aa3b2;
      --mint:#22c55e;
      --shadow:0 6px 24px rgba(0,0,0,.3);
      --link:#93c5fd;
      --body-fill:#e8eef2;
    }
    .light{
      --bg:#ffffff;
      --text:#0a0a0b;
      --panel:#f6f7f9;
      --panel-2:#ffffff;
      --border:#d0d7de;
      --muted:#495057;
      --mint:#22c55e;
      --shadow:0 2px 8px rgba(0,0,0,.08);
      --link:#1d4ed8;
      --body-fill:#1a1a1a;
    }

  /* Body silhouette */
  .body-svg{display:block;margin:1rem auto;width:100%;height:100%;max-width:200px}
  .body-base use{fill:var(--body-fill);stroke:var(--border);stroke-width:0.5}
  .body-outline use{fill:none;stroke:color-mix(in oklab, var(--border) 45%, #000);stroke-width:1.6}
  .region-band{fill:transparent;opacity:0;transition:fill .2s ease, opacity .2s ease, stroke .2s ease}
  /* Highlighted regions with fallback colors */
  .region-band.highlight{
    fill:#22c55e !important;/* fallback - force visibility */
    fill:color-mix(in srgb, var(--mint) 80%, #ffffff 20%) !important;
    opacity:.85 !important;
    stroke:#0f766e !important;/* fallback */
    stroke:color-mix(in oklab, var(--mint) 70%, #0f766e) !important;
    stroke-width:2.5;
  }
  .light .region-band.highlight{
    fill:#14b8a6 !important;/* fallback */
    fill:color-mix(in srgb, var(--mint) 80%, #000000 20%) !important;
    opacity:.8 !important;
    stroke:#047857 !important;
    stroke-width:2.8;
  }


    /* Base: keep your CSS backgrounds; only remove default margins to kill seam */
    html, body { margin:0; color:var(--text); }
    a{ color:var(--link); }

    /* Avoid top margin collapse that looks like a seam under the navbar */
    .content > :first-child { margin-top: 0; }

    /* Light-mode readability without touching layout or backgrounds */
    .light .report,
    .light .report *:not(strong.negative):not(strong.positive):not(.ii-neg):not(.ii-pos),
    .light .patient-card,
    .light .patient-card *,
    .light details,
    .light details *,
    .light pre,
    .light code { color: var(--text) !important; }

    .light .simple-output strong.negative { color:#b91c1c !important; }
    .light .simple-output strong.positive { color:#166534 !important; }
    
    /* Preserve highlight colors in light mode */
    .light .ii-neg,
    .light .ii-neg * { color:#dc2626 !important; }
    .light .ii-pos,
    .light .ii-pos * { color:#16a34a !important; }
    .light .ii-text { color: var(--text) !important; }

    /* Components */
    .diagram-container{
      position:relative; width:200px; height:500px; margin:1rem auto;
      background-color:var(--panel-2); border-radius:10px; box-shadow:var(--shadow);
    }

    .patient-card{ margin-bottom:2rem; }
    .stat-badges{ display:flex; gap:.5rem; flex-wrap:wrap; margin:.5rem 0 1rem; }
    .badge{ border:1px solid var(--border); background:var(--panel); border-radius:10px; padding:.35rem .6rem; font-size:.85rem; }
    .stats-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:.75rem; }
    .stat-card{ background:var(--panel); border:1px solid var(--border); border-radius:10px; padding:.7rem .8rem; }
    .stat-card .label{ color:var(--muted); font-size:.8rem; display:block; }
    .stat-card .value{ font-weight:700; }

    .simple-output ul{ margin:.25rem 0 0; padding-left:1.1rem; }
    .simple-output li{ margin:.2rem 0; }
    .simple-output strong.negative{ color:#ff6b6b; cursor:help; position:relative; }
    .simple-output strong.positive{ color:#4cc96c; }
    .simple-output [data-def]{ text-decoration:underline dotted; cursor:help; }

    /* Tooltip */
    .def-tooltip{
      position:fixed; z-index:9998; background:var(--panel); color:var(--text);
      border:1px solid var(--border); border-radius:10px; padding:.5rem .6rem; box-shadow:var(--shadow);
      max-width:260px; font-size:.9rem; line-height:1.2; transform:translate(-50%,-100%); pointer-events:none;
    }
    .def-tooltip.hidden{ display:none; }
    .def-tooltip::after{
      content:""; position:absolute; left:50%; bottom:-8px; transform:translateX(-50%);
      width:0; height:0; border-left:8px solid transparent; border-right:8px solid transparent; border-top:8px solid var(--panel);
    }

    /* Brain summary diagrams */
    .brain-visual-section{
      margin:2rem 0;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:1.5rem;
      box-shadow:var(--shadow);
    }
    .brain-visual-section h2{margin-top:0; color:var(--mint);}
    .brain-summary{margin:0 0 1rem; color:var(--muted);}
    .brain-diagrams{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(180px,1fr));
      gap:1.5rem;
      margin-bottom:1rem;
    }
    .brain-view{
      background:var(--panel-2);
      border:1px solid var(--border);
      border-radius:12px;
      padding:1.2rem;
      display:flex;
      flex-direction:column;
      gap:0.75rem;
      align-items:center;
      box-shadow:var(--shadow);
      text-align:center;
      margin:0;
    }
    .brain-view figcaption{font-size:0.9rem; font-weight:600; color:var(--text); margin:0;}
    .brain-svg{width:100%; height:auto; max-width:200px; filter:drop-shadow(0 2px 4px rgba(0,0,0,0.1));}
    .brain-outline{stroke:rgb(70,110,125); stroke-width:2.5;}
    .brain-highlight{stroke:rgb(180,50,40); stroke-width:1.5;}
    .light .brain-outline{stroke:rgb(90,130,145);}
    .light .brain-highlight{stroke:rgb(200,60,50);}
    .brain-notes{margin:1rem 0 0; padding-left:1.3rem; color:var(--muted); list-style-type:disc;}
    .brain-notes li{margin:0.4rem 0; line-height:1.5;}

    /* Anatomy image-based visualization */
    .anatomy-image-container{
      background:var(--panel-2);
      border:1px solid var(--border);
      border-radius:12px;
      padding:1.5rem;
      margin:1rem auto;
      max-width:600px;
      box-shadow:var(--shadow);
    }
    .anatomy-image-wrapper{
      position:relative;
      display:flex;
      justify-content:center;
      align-items:center;
      margin:0 auto;
    }
    .spine-diagram-svg{
      width:100%;
      max-width:300px;
      height:auto;
      display:block;
      filter:drop-shadow(0 2px 6px rgba(0,0,0,0.15));
    }
    .organ-diagram-svg{
      width:100%;
      max-width:350px;
      height:auto;
      display:block;
      filter:drop-shadow(0 2px 6px rgba(0,0,0,0.15));
    }
    .spine-highlight{
      stroke:#fff;
      stroke-width:2.5;
    }
    /* Removed .organ-highlight and pulse-highlight animation */
    .light .spine-diagram-svg text{
      fill:#1a1a1a !important;
    }
    .light .organ-diagram-svg text{
      fill:#1a1a1a !important;
    }
    .light .spine-diagram-svg .spine-highlight{
      stroke:#000;
    }
    .anatomy-legend{
      margin-top:1rem;
      text-align:center;
      color:var(--muted);
      font-size:0.9rem;
    }
    .legend-circle{
      display:inline-block;
      width:14px;
      height:14px;
      background:#ef4444;
      border:2px solid #fff;
      border-radius:50%;
      vertical-align:middle;
      margin-right:6px;
    }
    .legend-highlight-line{
      display:inline-block;
      width:20px;
      height:3px;
      background:#ef4444;
      border-radius:2px;
      vertical-align:middle;
      margin-right:6px;
    }
    .legend-highlight-area{
      display:inline-block;
      width:14px;
      height:14px;
      background:#ef4444;
      border-radius:3px;
      vertical-align:middle;
      margin-right:6px;
      opacity:0.7;
    }
    .light .legend-circle{
      border-color:#000;
    }

    /* Modal */
    .organ-modal{ position:fixed; inset:0; z-index:9997; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.45); backdrop-filter:saturate(120%) blur(2px); }
    .organ-modal.show{ display:flex; }
    .organ-card{ background:var(--panel); color:var(--text); border:1px solid var(--border);
      border-radius:14px; padding:16px 18px; box-shadow:var(--shadow); width:min(92vw,680px); }
    .organ-card header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem; }
    .organ-card button{ background:transparent; color:inherit; border:1px solid var(--border); border-radius:8px; padding:.35rem .6rem; cursor:pointer; }
    .organ-link{ text-decoration:underline dotted; cursor:pointer; }

    /* Theme switch */
    .theme-switch{ display:inline-grid; grid-template-rows:auto auto; gap:6px; user-select:none; cursor:pointer; }
    .theme-row{ display:grid; grid-template-columns:auto auto auto; align-items:center; gap:8px 10px; min-height:28px; }
    .theme-icon{ font-size:18px; line-height:1; }
    .theme-switch-input{ position:absolute; opacity:0; width:1px; height:1px; }
    .theme-switch-track{
      position:relative; display:inline-block; width:56px; height:28px; border-radius:999px;
      background:var(--panel); border:1px solid var(--border); box-shadow:var(--shadow); vertical-align:middle;
    }
    .theme-switch-track::after{
      content:""; position:absolute; left:2px; top:50%; width:24px; height:24px; border-radius:50%;
      background:var(--bg); box-shadow:0 2px 6px rgba(0,0,0,.25); transform:translate(0,-50%); transition:transform .2s ease;
    }
    .theme-switch-input:checked + .theme-switch-track::after{ transform:translate(28px,-50%); }
    .theme-switch-text{ text-align:center; font-size:.9rem; color:var(--muted); }
    .theme-row .theme-icon:first-of-type{ opacity:1; }
    .theme-row .theme-icon:last-of-type{ opacity:.5; }
    .light .theme-row .theme-icon:first-of-type{ opacity:.5; }
    .light .theme-row .theme-icon:last-of-type{ opacity:1; }
    .theme-switch-input:focus-visible + .theme-switch-track{ outline:2px solid var(--mint); outline-offset:2px; }
  </style>
</head>

<body>
<div class="page-wrapper">
  <header class="navbar">
    <div class="navbar-brand">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="Inside Imaging logo">
      <span class="brand-name">Inside Imaging</span>
    </div>
    <nav class="nav-links">
      <a href="{{ url_for('projects') }}">Projects</a>
      <a href="{{ url_for('dashboard') }}">Dashboard</a>
      <a href="{{ url_for('report_status') }}">Statistics</a>
      <a href="{{ url_for('team') }}">Our Team</a>
      <!-- <a href="{{ url_for('payment') }}">Payment</a> -->
      <a href="{{ url_for('help_page') }}">Help</a>
    </nav>
    <div class="nav-auth">
      <label class="theme-switch" aria-label="Toggle theme">
        <span class="theme-row">
          <span class="theme-icon" aria-hidden="true">🌙</span>
          <input id="theme-toggle" class="theme-switch-input" type="checkbox" role="switch" aria-checked="false">
          <span class="theme-switch-track" aria-hidden="true"></span>
          <span class="theme-icon" aria-hidden="true">☀️</span>
        </span>
        <span id="theme-label" class="theme-switch-text">Dark mode</span>
      </label>

      {% if session.get('username') %}
        <div class="user-menu">
          <button class="user-menu-toggle" type="button" aria-expanded="false">
            <span class="user-name" aria-live="polite">{{ session.get('username') }}</span>
            <span class="user-caret" aria-hidden="true">▾</span>
          </button>
          <div class="user-menu-dropdown" role="menu" hidden>
            <a href="{{ url_for('profile') }}" role="menuitem">Profile</a>
            <a href="{{ url_for('logout') }}" role="menuitem">Log Out</a>
          </div>
        </div>
      {% else %}
        <a href="{{ url_for('login') }}" class="login-button">Log In</a>
        <a href="{{ url_for('signup') }}" class="signup-button">Sign Up</a>
      {% endif %}
    </div>
  </header>

  <main class="content">
    <h1>Report Summary</h1>

    <div class="patient-card">
      <div><span class="lbl">Hospital</span><strong>{{ patient.hospital|default('', true) }}</strong></div>
      <div><span class="lbl">Study</span><strong>{{ patient.study|default('Unknown', true) }}</strong></div>
      {% if patient.name %}
      <div><span class="lbl">Name</span><strong>{{ patient.name }}</strong></div>
      {% endif %}
      <div><span class="lbl">Sex</span><strong>{{ patient.sex|default('', true) }}</strong></div>
      <div><span class="lbl">Age</span><strong>{{ patient.age|default('', true) }}</strong></div>
      <div><span class="lbl">Date</span><strong>{{ patient.date|default('', true) }}</strong></div>
    </div>

    <section>
      <h2>Body Region Highlight</h2>
      <div id="diagram-container" class="diagram-container" data-organ="{{ patient.study|default('', true)|lower }}"></div>
    </section>

    {# Old 3-plane reconstruction visualizations removed - using universal organ detection system below #}
    {# ANATOMY DIAGRAMS DISABLED - Uncomment sections below to re-enable #}
    {% if false %}
      {% if 'spine' in (patient.study|default('', true)|lower) or 'vertebra' in (patient.study|default('', true)|lower) or 'spinal' in (patient.study|default('', true)|lower) or 'cervical' in (patient.study|default('', true)|lower) or 'lumbar' in (patient.study|default('', true)|lower) or 'thoracic' in (patient.study|default('', true)|lower) %}
      <section class="organ-visual-section" data-organ="spine">
      <h2>Spine Visualization</h2>
      <p class="organ-summary">An anatomical diagram showing the approximate location of findings. This is for illustrative purposes only.</p>
      <div class="anatomy-image-container">
        <div class="anatomy-image-wrapper">
          <!-- Simple built-in spine diagram using SVG -->
          <svg class="spine-diagram-svg" viewBox="0 0 300 600" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="vertebraGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style="stop-color:#e0e7ee;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#b8c5d3;stop-opacity:1" />
              </linearGradient>
            </defs>
            
            <!-- Spinal column background -->
            <path d="M150,20 Q145,300 150,580" stroke="#8899aa" stroke-width="35" fill="none" opacity="0.3"/>
            
            <!-- Cervical spine (neck) - C1-C7 -->
            <g id="cervical">
              <text x="30" y="45" font-size="14" fill="var(--muted)" font-weight="600">Cervical</text>
              <text x="30" y="62" font-size="11" fill="var(--muted)">(Neck)</text>
              
              <rect x="120" y="50" width="60" height="18" rx="4" fill="url(#vertebraGrad)" stroke="#7788aa" stroke-width="1.5"/>
              <text x="185" y="62" font-size="10" fill="var(--text)">C1</text>
              
              <rect x="120" y="72" width="60" height="18" rx="4" fill="url(#vertebraGrad)" stroke="#7788aa" stroke-width="1.5"/>
              <text x="185" y="84" font-size="10" fill="var(--text)">C2</text>
              
              <rect x="120" y="94" width="60" height="18" rx="4" fill="url(#vertebraGrad)" stroke="#7788aa" stroke-width="1.5"/>
              <text x="185" y="106" font-size="10" fill="var(--text)">C3</text>
              
              <rect x="120" y="116" width="60" height="18" rx="4" fill="url(#vertebraGrad)" stroke="#7788aa" stroke-width="1.5"/>
              <text x="185" y="128" font-size="10" fill="var(--text)">C4</text>
              
              <rect x="120" y="138" width="60" height="18" rx="4" fill="url(#vertebraGrad)" stroke="#7788aa" stroke-width="1.5"/>
              <text x="185" y="150" font-size="10" fill="var(--text)">C5</text>
              
              <rect x="120" y="160" width="60" height="18" rx="4" fill="url(#vertebraGrad)" stroke="#7788aa" stroke-width="1.5"/>
              <text x="185" y="172" font-size="10" fill="var(--text)">C6</text>
              
              <rect x="120" y="182" width="60" height="18" rx="4" fill="url(#vertebraGrad)" stroke="#7788aa" stroke-width="1.5"/>
              <text x="185" y="194" font-size="10" fill="var(--text)">C7</text>
            </g>
            
            <!-- Thoracic spine (mid-back) - T1-T12 -->
            <g id="thoracic">
              <text x="30" y="225" font-size="14" fill="var(--muted)" font-weight="600">Thoracic</text>
              <text x="30" y="242" font-size="11" fill="var(--muted)">(Mid-back)</text>
              
              <rect x="120" y="210" width="60" height="16" rx="3" fill="url(#vertebraGrad)" stroke="#7788aa" stroke-width="1.5"/>
              <text x="185" y="220" font-size="9" fill="var(--text)">T1-T12</text>
              <rect x="120" y="228" width="60" height="16" rx="3" fill="url(#vertebraGrad)" stroke="#7788aa" stroke-width="1.5"/>
              <rect x="120" y="246" width="60" height="16" rx="3" fill="url(#vertebraGrad)" stroke="#7788aa" stroke-width="1.5"/>
              <rect x="120" y="264" width="60" height="16" rx="3" fill="url(#vertebraGrad)" stroke="#7788aa" stroke-width="1.5"/>
              <rect x="120" y="282" width="60" height="16" rx="3" fill="url(#vertebraGrad)" stroke="#7788aa" stroke-width="1.5"/>
              <rect x="120" y="300" width="60" height="16" rx="3" fill="url(#vertebraGrad)" stroke="#7788aa" stroke-width="1.5"/>
              <rect x="120" y="318" width="60" height="16" rx="3" fill="url(#vertebraGrad)" stroke="#7788aa" stroke-width="1.5"/>
              <rect x="120" y="336" width="60" height="16" rx="3" fill="url(#vertebraGrad)" stroke="#7788aa" stroke-width="1.5"/>
              <rect x="120" y="354" width="60" height="16" rx="3" fill="url(#vertebraGrad)" stroke="#7788aa" stroke-width="1.5"/>
              <rect x="120" y="372" width="60" height="16" rx="3" fill="url(#vertebraGrad)" stroke="#7788aa" stroke-width="1.5"/>
              <rect x="120" y="390" width="60" height="16" rx="3" fill="url(#vertebraGrad)" stroke="#7788aa" stroke-width="1.5"/>
              <rect x="120" y="408" width="60" height="16" rx="3" fill="url(#vertebraGrad)" stroke="#7788aa" stroke-width="1.5"/>
            </g>
            
            <!-- Lumbar spine (lower back) - L1-L5 -->
            <g id="lumbar">
              <text x="30" y="450" font-size="14" fill="var(--muted)" font-weight="600">Lumbar</text>
              <text x="30" y="467" font-size="11" fill="var(--muted)">(Lower back)</text>
              
              <rect x="120" y="435" width="60" height="20" rx="4" fill="url(#vertebraGrad)" stroke="#7788aa" stroke-width="1.5"/>
              <text x="185" y="448" font-size="10" fill="var(--text)">L1</text>
              
              <rect x="120" y="458" width="60" height="20" rx="4" fill="url(#vertebraGrad)" stroke="#7788aa" stroke-width="1.5"/>
              <text x="185" y="471" font-size="10" fill="var(--text)">L2</text>
              
              <rect x="120" y="481" width="60" height="20" rx="4" fill="url(#vertebraGrad)" stroke="#7788aa" stroke-width="1.5"/>
              <text x="185" y="494" font-size="10" fill="var(--text)">L3</text>
              
              <rect x="120" y="504" width="60" height="20" rx="4" fill="url(#vertebraGrad)" stroke="#7788aa" stroke-width="1.5"/>
              <text x="185" y="517" font-size="10" fill="var(--text)">L4</text>
              
              <rect x="120" y="527" width="60" height="20" rx="4" fill="url(#vertebraGrad)" stroke="#7788aa" stroke-width="1.5"/>
              <text x="185" y="540" font-size="10" fill="var(--text)">L5</text>
            </g>
            
            <!-- Sacrum (tailbone) -->
            <g id="sacrum">
              <text x="30" y="565" font-size="14" fill="var(--muted)" font-weight="600">Sacrum</text>
              <text x="30" y="582" font-size="11" fill="var(--muted)">(Tailbone)</text>
              
              <path d="M120,550 L120,580 Q150,590 180,580 L180,550 Z" fill="url(#vertebraGrad)" stroke="#7788aa" stroke-width="1.5"/>
              <text x="185" y="568" font-size="10" fill="var(--text)">S1</text>
            </g>
            
            <!-- Dynamic highlight overlays based on findings -->
            {% set findings_lower = (structured.findings|default('', true)|lower) %}
            {% set conclusion_lower = (structured.conclusion|default('', true)|lower) %}
            
            <!-- Cervical highlights -->
            {% if 'c3/4' in findings_lower or 'c3/c4' in findings_lower or 'c3/4' in conclusion_lower %}
            <circle cx="210" cy="107" r="16" class="spine-highlight" fill="#ef4444" opacity="0.8"/>
            <text x="235" y="112" font-size="12" fill="#ef4444" font-weight="700">C3/4</text>
            {% endif %}
            {% if 'c4/5' in findings_lower or 'c4/c5' in findings_lower or 'c4/5' in conclusion_lower %}
            <circle cx="210" cy="129" r="16" class="spine-highlight" fill="#ef4444" opacity="0.8"/>
            <text x="235" y="134" font-size="12" fill="#ef4444" font-weight="700">C4/5</text>
            {% endif %}
            {% if 'c5/6' in findings_lower or 'c5/c6' in findings_lower or 'c5/6' in conclusion_lower %}
            <circle cx="210" cy="151" r="16" class="spine-highlight" fill="#ef4444" opacity="0.8"/>
            <text x="235" y="156" font-size="12" fill="#ef4444" font-weight="700">C5/6</text>
            {% endif %}
            {% if 'c6/7' in findings_lower or 'c6/c7' in findings_lower or 'c6/7' in conclusion_lower %}
            <circle cx="210" cy="173" r="16" class="spine-highlight" fill="#ef4444" opacity="0.8"/>
            <text x="235" y="178" font-size="12" fill="#ef4444" font-weight="700">C6/7</text>
            {% endif %}
            
            <!-- Lumbar highlights -->
            {% if 'l1/2' in findings_lower or 'l1/l2' in findings_lower or 'l1/2' in conclusion_lower %}
            <circle cx="210" cy="448" r="16" class="spine-highlight" fill="#ef4444" opacity="0.8"/>
            <text x="235" y="453" font-size="12" fill="#ef4444" font-weight="700">L1/2</text>
            {% endif %}
            {% if 'l2/3' in findings_lower or 'l2/l3' in findings_lower or 'l2/3' in conclusion_lower %}
            <circle cx="210" cy="471" r="16" class="spine-highlight" fill="#ef4444" opacity="0.8"/>
            <text x="235" y="476" font-size="12" fill="#ef4444" font-weight="700">L2/3</text>
            {% endif %}
            {% if 'l3/4' in findings_lower or 'l3/l4' in findings_lower or 'l3/4' in conclusion_lower %}
            <circle cx="210" cy="494" r="16" class="spine-highlight" fill="#ef4444" opacity="0.8"/>
            <text x="235" y="499" font-size="12" fill="#ef4444" font-weight="700">L3/4</text>
            {% endif %}
            {% if 'l4/5' in findings_lower or 'l4/l5' in findings_lower or 'l4/5' in conclusion_lower %}
            <circle cx="210" cy="517" r="16" class="spine-highlight" fill="#ef4444" opacity="0.8"/>
            <text x="235" y="522" font-size="12" fill="#ef4444" font-weight="700">L4/5</text>
            {% endif %}
            {% if 'l5/s1' in findings_lower or 'l5/s1' in conclusion_lower %}
            <circle cx="210" cy="540" r="16" class="spine-highlight" fill="#ef4444" opacity="0.8"/>
            <text x="235" y="545" font-size="12" fill="#ef4444" font-weight="700">L5/S1</text>
            {% endif %}
          </svg>
        </div>
        
        <div class="anatomy-legend">
          <p><span class="legend-circle"></span> = Problem area mentioned in your report</p>
        </div>
      </div>
    </section>
    {% endif %}
    {% endif %}

    {# Universal Organ Visualization System - Using Real Medical Images #}
    {% if false %}
    {% set findings_text = (structured.findings|default('', true) + ' ' + structured.conclusion|default('', true))|lower %}
    {% set study_text = (patient.study|default('', true))|lower %}
    
    {# Detect which organs are mentioned #}
    {% set show_heart = ('heart' in findings_text or 'cardiac' in findings_text or 'pericardial' in findings_text or 'myocardial' in findings_text or 'heart' in study_text) %}
    {% set show_lungs = ('lung' in findings_text or 'pulmonary' in findings_text or 'pleural' in findings_text or 'chest' in study_text or 'thorax' in study_text) %}
    {% set show_liver = ('liver' in findings_text or 'hepatic' in findings_text or 'liver' in study_text) %}
    {% set show_kidneys = ('kidney' in findings_text or 'renal' in findings_text or 'kidney' in study_text or 'renal' in study_text) %}
    {% set show_pancreas = ('pancreas' in findings_text or 'pancreatic' in findings_text) %}
    {% set show_abdomen = ('abdomen' in findings_text or 'abdominal' in study_text or 'pelvis' in study_text) %}
    {% set show_brain = ('brain' in findings_text or 'cerebral' in findings_text or 'head' in study_text or 'brain' in study_text) %}
    
    {# Heart Visualization #}
    {% if show_heart %}
    <section class="organ-visual-section" data-organ="heart">
      <h2>Heart Anatomy</h2>
      <p class="organ-summary">Medical diagram showing the heart structure mentioned in your report.</p>
      <div class="anatomy-image-container">
        <div class="anatomy-image-wrapper" style="position: relative; max-width: 600px; margin: 0 auto;">
          <img src="{{ url_for('static', filename='images/anatomy/heart.svg') }}" 
               alt="Heart anatomy diagram" 
               style="width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          
          {# Problem indicators overlay #}
          {% if 'pericardial effusion' in findings_text %}
          <div style="position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(239, 68, 68, 0.95); color: white; padding: 14px 24px; border-radius: 10px; font-size: 15px; font-weight: 700; box-shadow: 0 4px 16px rgba(0,0,0,0.5); border: 3px solid white; z-index: 10;">
            ⚠️ Pericardial effusion (fluid around heart)
          </div>
          {% endif %}
          {% if 'cardiomegaly' in findings_text or 'enlarged heart' in findings_text %}
          <div style="position: absolute; top: 30px; right: 20px; background: rgba(239, 68, 68, 0.95); color: white; padding: 14px 24px; border-radius: 10px; font-size: 15px; font-weight: 700; box-shadow: 0 4px 16px rgba(0,0,0,0.5); border: 3px solid white; z-index: 10;">
            ⚠️ Enlarged heart
          </div>
          {% endif %}
        </div>
        <div class="anatomy-legend" style="margin-top: 1.5rem; text-align: center; color: var(--muted); font-size: 0.95rem;">
          <p><strong>Medical reference diagram</strong> - Red warnings show issues from your report</p>
        </div>
      </div>
    </section>
    {% endif %}
    
    {# Lungs Visualization #}
    {% if show_lungs %}
    <section class="organ-visual-section" data-organ="lungs">
      <h2>Lung Anatomy</h2>
      <p class="organ-summary">Medical diagram showing the lung structure mentioned in your report.</p>
      <div class="anatomy-image-container">
        <div class="anatomy-image-wrapper" style="position: relative; max-width: 600px; margin: 0 auto;">
          <img src="{{ url_for('static', filename='images/anatomy/lungs.svg') }}" 
               alt="Lung anatomy diagram" 
               style="width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          
          {# Problem indicators overlay - always visible #}
          {% if 'pleural effusion' in findings_text %}
          <div style="position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(239, 68, 68, 0.95); color: white; padding: 14px 24px; border-radius: 10px; font-size: 15px; font-weight: 700; box-shadow: 0 4px 16px rgba(0,0,0,0.5); border: 3px solid white; z-index: 10;">
            ⚠️ Pleural effusion (fluid around lungs)
          </div>
          {% endif %}
          {% if 'pneumonia' in findings_text or 'consolidation' in findings_text %}
          <div style="position: absolute; top: 30px; right: 20px; background: rgba(239, 68, 68, 0.95); color: white; padding: 14px 24px; border-radius: 10px; font-size: 15px; font-weight: 700; box-shadow: 0 4px 16px rgba(0,0,0,0.5); border: 3px solid white; z-index: 10;">
            ⚠️ Pneumonia/Consolidation
          </div>
          {% endif %}
          {% if 'nodule' in findings_text %}
          <div style="position: absolute; top: 30px; left: 20px; background: rgba(239, 68, 68, 0.95); color: white; padding: 14px 24px; border-radius: 10px; font-size: 15px; font-weight: 700; box-shadow: 0 4px 16px rgba(0,0,0,0.5); border: 3px solid white; z-index: 10;">
            ⚠️ Lung nodule detected
          </div>
          {% endif %}
        </div>
        <div class="anatomy-legend" style="margin-top: 1.5rem; text-align: center; color: var(--muted); font-size: 0.95rem;">
          <p><strong>Medical reference diagram</strong> - Red warnings show issues from your report</p>
        </div>
      </div>
    </section>
    {% endif %}

    {# Liver Visualization #}
    {% if show_liver %}
    <section class="organ-visual-section" data-organ="liver">
      <h2>Liver Anatomy</h2>
      <p class="organ-summary">Medical diagram showing the liver structure mentioned in your report.</p>
      <div class="anatomy-image-container">
        <div class="anatomy-image-wrapper" style="position: relative; max-width: 600px; margin: 0 auto;">
          <img src="{{ url_for('static', filename='images/anatomy/liver.svg') }}" 
               alt="Liver anatomy diagram" 
               style="width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          
          {# Problem indicators overlay - always visible #}
          {% if 'lesion' in findings_text or 'mass' in findings_text %}
          <div style="position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(239, 68, 68, 0.95); color: white; padding: 14px 24px; border-radius: 10px; font-size: 15px; font-weight: 700; box-shadow: 0 4px 16px rgba(0,0,0,0.5); border: 3px solid white; z-index: 10;">
            ⚠️ Liver lesion/mass detected
          </div>
          {% endif %}
          {% if 'cirrhosis' in findings_text or 'fatty' in findings_text %}
          <div style="position: absolute; top: 30px; right: 20px; background: rgba(239, 68, 68, 0.95); color: white; padding: 14px 24px; border-radius: 10px; font-size: 15px; font-weight: 700; box-shadow: 0 4px 16px rgba(0,0,0,0.5); border: 3px solid white; z-index: 10;">
            ⚠️ Liver changes detected
          </div>
          {% endif %}
        </div>
        <div class="anatomy-legend" style="margin-top: 1.5rem; text-align: center; color: var(--muted); font-size: 0.95rem;">
          <p><strong>Medical reference diagram</strong> - Red warnings show issues from your report</p>
        </div>
      </div>
    </section>
    {% endif %}

    {# Kidneys Visualization #}
    {% if show_kidneys %}
    <section class="organ-visual-section" data-organ="kidneys">
      <h2>Kidney Anatomy</h2>
      <p class="organ-summary">Medical diagram showing the kidney structure mentioned in your report.</p>
      <div class="anatomy-image-container">
        <div class="anatomy-image-wrapper" style="position: relative; max-width: 600px; margin: 0 auto;">
          <img src="https://upload.wikimedia.org/wikipedia/commons/3/3c/Blausen_0592_KidneyAnatomy_02.png" 
               alt="Kidney anatomy diagram" 
               style="width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
               onerror="this.onerror=null; this.src='https://upload.wikimedia.org/wikipedia/commons/2/27/Kidney_nephron_molar_09.svg';">
          
          {# Problem indicators overlay - always visible #}
          {% if 'stone' in findings_text or 'calculus' in findings_text %}
          <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(239, 68, 68, 0.95); color: white; padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: 700; box-shadow: 0 4px 12px rgba(0,0,0,0.4); border: 2px solid white;">
            ⚠️ Kidney stone detected
          </div>
          {% endif %}
          {% if 'cyst' in findings_text %}
          <div style="position: absolute; top: 20px; right: 20px; background: rgba(239, 68, 68, 0.95); color: white; padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: 700; box-shadow: 0 4px 12px rgba(0,0,0,0.4); border: 2px solid white;">
            ⚠️ Kidney cyst detected
          </div>
          {% endif %}
        </div>
        <div class="anatomy-legend" style="margin-top: 1.5rem; text-align: center; color: var(--muted); font-size: 0.95rem;">
          <p><strong>Reference diagram</strong> - Red warnings show issues from your report</p>
        </div>
      </div>
    </section>
    {% endif %}

    {# Brain Visualization #}
    {% if show_brain %}
    <section class="organ-visual-section" data-organ="brain">
      <h2>Brain Anatomy</h2>
      <p class="organ-summary">Medical diagram showing the brain structure mentioned in your report.</p>
      <div class="anatomy-image-container">
        <div class="anatomy-image-wrapper" style="position: relative; max-width: 600px; margin: 0 auto;">
          <img src="https://upload.wikimedia.org/wikipedia/commons/4/45/Blausen_0114_BrainStructures.png" 
               alt="Brain anatomy diagram" 
               style="width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
               onerror="this.onerror=null; this.src='https://upload.wikimedia.org/wikipedia/commons/a/a4/Human_brain_diagram.svg';">
          
          {# Problem indicators overlay - always visible #}
          {% if 'lesion' in findings_text or 'mass' in findings_text %}
          <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(239, 68, 68, 0.95); color: white; padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: 700; box-shadow: 0 4px 12px rgba(0,0,0,0.4); border: 2px solid white;">
            ⚠️ Brain lesion detected
          </div>
          {% endif %}
          {% if 'stroke' in findings_text or 'infarct' in findings_text %}
          <div style="position: absolute; top: 20px; right: 20px; background: rgba(239, 68, 68, 0.95); color: white; padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: 700; box-shadow: 0 4px 12px rgba(0,0,0,0.4); border: 2px solid white;">
            ⚠️ Stroke/Infarct detected
          </div>
          {% endif %}
        </div>
        <div class="anatomy-legend" style="margin-top: 1.5rem; text-align: center; color: var(--muted); font-size: 0.95rem;">
          <p><strong>Reference diagram</strong> - Red warnings show issues from your report</p>
        </div>
      </div>
    </section>
    {% endif %}

    {# Abdominal Overview - Only if pancreas or general abdomen mentioned but not specific organs #}
    {% if (show_pancreas or show_abdomen) and not (show_liver or show_kidneys) %}
    <section class="organ-visual-section" data-organ="abdomen">
      <h2>Abdominal Anatomy</h2>
      <p class="organ-summary">Medical diagram showing the abdominal organs mentioned in your report.</p>
      <div class="anatomy-image-container">
        <div class="anatomy-image-wrapper" style="position: relative; max-width: 600px; margin: 0 auto;">
          <img src="https://upload.wikimedia.org/wikipedia/commons/6/69/Blausen_0013_AbdominalOrgans_Lateral.png" 
               alt="Abdominal organs anatomy diagram" 
               style="width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
               onerror="this.onerror=null; this.src='https://upload.wikimedia.org/wikipedia/commons/8/85/Surface_projections_of_the_organs_of_the_trunk.png';">
          
          {# Problem indicators overlay - always visible #}
          {% if 'pancreas' in findings_text and ('mass' in findings_text or 'tumor' in findings_text) %}
          <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(239, 68, 68, 0.95); color: white; padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: 700; box-shadow: 0 4px 12px rgba(0,0,0,0.4); border: 2px solid white;">
            ⚠️ Pancreatic mass detected
          </div>
          {% endif %}
        </div>
        <div class="anatomy-legend" style="margin-top: 1.5rem; text-align: center; color: var(--muted); font-size: 0.95rem;">
          <p><strong>Reference diagram</strong> - Red warnings show issues from your report</p>
        </div>
      </div>
    </section>
    {% endif %}
    {% endif %}

    {% set lang_lower = (language or 'English')|lower %}
    {% set is_sw = lang_lower in ['kiswahili','swahili'] %}
    {% if language and (language != 'English' and not is_sw) %}
      <p class="lang-warning">Translation into {{ language }} is not yet supported. Displaying English.</p>
    {% endif %}

    <section class="report-section">
      <h2>Report Statistics</h2>
      <div class="stat-badges">
        <span class="badge">Words: {{ structured.word_count|default(report_stats.words, true) }}</span>
        <span class="badge">Sentences: {{ structured.sentence_count|default(report_stats.sentences, true) }}</span>
        <span class="badge positive">Highlighted positive: {{ structured.highlights_positive|default(report_stats.highlights_positive, true) }}</span>
        <span class="badge negative">Highlighted negative: {{ structured.highlights_negative|default(report_stats.highlights_negative, true) }}</span>
      </div>
      <div class="stats-grid">
        <div class="stat-card"><span class="label">Comparison</span><span class="value">{{ structured.comparison or 'None' }}</span></div>
        <div class="stat-card"><span class="label">Oral contrast</span><span class="value">{{ structured.oral_contrast or 'Not stated' }}</span></div>
      </div>
    </section>

    <section class="report-actions" style="margin:1rem 0;">
      <form method="post" action="{{ url_for('download_pdf') }}">
        <textarea name="structured" hidden>{{ structured|tojson }}</textarea>
        <textarea name="patient" hidden>{{ patient|tojson }}</textarea>
        <button type="submit" class="btn">Download PDF</button>
      </form>
    </section>

    <div class="report">
      <section>
        <h3>{{ 'Sababu ya Uchunguzi' if is_sw else 'Reason for the Scan' }}</h3>
        <p class="simple-output">{{ structured.reason|default('', true)|safe }}</p>
      </section>
      <section>
        <h3>{{ 'Maelezo ya Utaratibu' if is_sw else 'Procedure Details' }}</h3>
        <p class="simple-output">{{ structured.technique|default('', true)|safe }}</p>
      </section>
      <section class="important-findings">
        <h3>{{ 'Matokeo Muhimu' if is_sw else 'Important Findings' }}</h3>
        <div class="simple-output">{{ structured.findings|default('', true)|safe }}</div>
      </section>
      <section>
        <h3>{{ 'Hitimisho' if is_sw else 'Conclusion' }}</h3>
        <div class="simple-output">{{ structured.conclusion|default('', true)|safe }}</div>
      </section>
      {% if structured.concern %}
      <section class="warn">
        <h3>{{ 'Tahadhari' if is_sw else 'Note of Concern' }}</h3>
        <p class="simple-output">{{ structured.concern|safe }}</p>
      </section>
      {% endif %}
    </div>

    <details>
      <summary>Extracted text</summary>
      <pre>{{ extracted }}</pre>
    </details>

    <p><a href="{{ url_for('dashboard') }}">&larr; Back to Dashboard</a></p>
  </main>

  {% include '_footer.html' %}
</div>

<div id="def-tooltip" class="def-tooltip hidden" role="tooltip" aria-hidden="true"></div>

<div id="organ-modal" class="organ-modal" aria-hidden="true">
  <div class="organ-card" role="dialog" aria-modal="true" aria-labelledby="organ-title">
    <header>
      <h3 id="organ-title">Organ</h3>
      <button type="button" id="organ-close">Close</button>
    </header>
    <div id="organ-content">
      <p>Viewer placeholder for <strong id="organ-name"></strong>.</p>
    </div>
  </div>
</div>

<script>
  var organFocus = JSON.parse('{{ (diagnosis.focus if diagnosis and diagnosis.focus else {})|tojson|safe }}');

  document.addEventListener('DOMContentLoaded', function(){
    /* Theme toggle that switches class and persists */
    var toggle = document.getElementById('theme-toggle');
    var label = document.getElementById('theme-label');
    var isLight = document.documentElement.classList.contains('light');
    if(toggle && label){
      toggle.checked = isLight;
      label.textContent = isLight ? 'Light mode' : 'Dark mode';
      toggle.setAttribute('aria-checked', String(isLight));
      toggle.addEventListener('change', function(){
        var nowLight = toggle.checked;
        document.documentElement.classList.toggle('light', nowLight);
        localStorage.setItem('theme', nowLight ? 'light' : 'dark');
        label.textContent = nowLight ? 'Light mode' : 'Dark mode';
        toggle.setAttribute('aria-checked', String(nowLight));
      });
    }

    /* Diagram highlight: SVG silhouette + clipped bands */
    var container = document.getElementById('diagram-container');
    console.log('Body diagram - container:', container);
    console.log('Body diagram - data-organ:', container ? container.dataset.organ : 'NO CONTAINER');
    function buildBodySVG(el){
      console.log('buildBodySVG called with:', el);
      el.innerHTML = `
    <svg class="body-svg" viewBox="0 0 200 500" role="img" aria-labelledby="bodyTitle">
      <title id="bodyTitle">Body region diagram</title>

      <defs>
        <!-- primitives -->
        <circle id="h"  cx="100" cy="58"  r="36"/>
  <rect   id="t"  x="58"  y="100" width="84" height="190" rx="22" ry="22"/>
  <rect   id="la" x="32"  y="130" width="28" height="150" rx="12" ry="12"/>
  <rect   id="ra" x="140" y="130" width="28" height="150" rx="12" ry="12"/>
  <rect   id="ll" x="66"  y="290" width="32" height="164" rx="6"  ry="6"/>
  <rect   id="rl" x="102" y="290" width="32" height="164" rx="6"  ry="6"/>

        <!-- region clips -->
        <clipPath id="clipHead"><use href="#h"/></clipPath>
        <clipPath id="clipTorso"><use href="#t"/></clipPath>
        <clipPath id="clipPelvis"><use href="#ll"/><use href="#rl"/></clipPath>
      </defs>

      <!-- solid silhouette under bands -->
      <g class="body-base" aria-hidden="true">
  <use href="#h"/><use href="#t"/><use href="#la"/><use href="#ra"/><use href="#ll"/><use href="#rl"/>
      </g>

      <!-- bands, each clipped to its region -->
      <g clip-path="url(#clipHead)">
        <rect class="region-band head" x="0" y="0" width="200" height="500"/>
      </g>
      <g clip-path="url(#clipTorso)">
        <!-- full torso (for single “body” highlight) -->
        <rect class="region-band torso"   x="0" y="0"   width="200" height="500"/>
        <!-- keep granular bands for CAP/AP -->
        <rect class="region-band chest"   x="0" y="90" width="220" height="135"/>
        <rect class="region-band abdomen" x="0" y="240" width="200" height="110"/>
      </g>
      <g clip-path="url(#clipPelvis)">
        <rect class="region-band pelvis" x="0" y="0" width="200" height="500"/>
      </g>

      <!-- outline on top -->
      <g class="body-outline" aria-hidden="true">
  <use href="#h"/><use href="#t"/><use href="#la"/><use href="#ra"/><use href="#ll"/><use href="#rl"/>
      </g>
    </svg>`;
      console.log('buildBodySVG - SVG inserted, innerHTML length:', el.innerHTML.length);
    }

    if(container){
      console.log('Building body SVG...');
      buildBodySVG(container);
      console.log('Body SVG built. Checking for SVG element:', container.querySelector('.body-svg'));
      // Robust region picker: supports "AP", "A/P", "CAP", full words, organs
      var text = (container.dataset.organ || '').toLowerCase();
      console.log('Region detection text:', text);
      function hits(rx){ return (text.match(rx) || []).length; }

      var scores = {
        head:    hits(/\b(brain|head|skull)\b/g),
        chest:   hits(/\b(chest|thorax|lung|heart)\b/g) + hits(/\bcap\b|chest\s*abd(?:omen)?\s*pelvis/g),
        abdomen: hits(/\b(abdomen|abdominal|liver|kidney|renal|pancreas|stomach|spleen|gallbladder)\b/g)
                + hits(/\ba\/p\b|\babd(?:omen)?\s*pelvis\b/g),
        pelvis:  hits(/\b(pelvis|pelvic|bladder|prostate|ovary|uterus)\b/g)
                + hits(/\ba\/p\b|\babd(?:omen)?\s*pelvis\b/g)
      };

      var ap  = /\ba\/p\b|\babd(?:omen)?\s*pelvis\b/.test(text);
      var cap = /\bcap\b|chest\s*abd(?:omen)?\s*pelvis/.test(text);
      var max = Math.max(scores.head, scores.chest, scores.abdomen, scores.pelvis);

      // If exactly one of chest/abdomen is referenced (not CAP/AP), fill full torso
      var torsoSingle = !ap && !cap && (Boolean(scores.chest) !== Boolean(scores.abdomen));
      if(torsoSingle){
        container.querySelector('.region-band.torso')?.classList.add('highlight');
      } else {
        ['head','chest','abdomen','pelvis'].forEach(function(r){
          var node = container.querySelector('.region-band.'+r);
          if(!node) return;
          var on = ap ? (r==='abdomen' || r==='pelvis')
                : cap ? (r==='chest' || r==='abdomen' || r==='pelvis')
                : scores[r] === max && max > 0;
          if(on) node.classList.add('highlight');
        });
        if(!container.querySelector('.region-band.highlight')){
          container.querySelector('.region-band.chest')?.classList.add('highlight');
        }
      }
      console.log('Body diagram highlighting complete. Highlighted elements:', container.querySelectorAll('.region-band.highlight').length);
    } else {
      console.error('Body diagram container not found!');
    }

    /* Dynamic brain lesion positioning */
    function parseBrainLesion() {
      var conclusion = ({{ structured.conclusion|default("", true)|tojson }} || "").toLowerCase().replace(/<[^>]+>/g, ' ');
      var findings = ({{ structured.findings|default("", true)|tojson }} || "").toLowerCase().replace(/<[^>]+>/g, ' ');
      var combinedText = conclusion + ' ' + findings;
      
      // Location mapping: [axial_x, axial_y, sagittal_x, sagittal_y, coronal_x, coronal_y]
      var locationMap = {
        'right frontoparietal': [145, 95, 100, 90, 155, 85],  // sagittal adjusted for corrected view
        'left frontoparietal': [95, 95, 100, 90, 85, 85],
        'right frontal': [140, 85, 85, 75, 150, 75],  // frontal is on left in sagittal view
        'left frontal': [100, 85, 85, 75, 90, 75],
        'right parietal': [150, 100, 110, 95, 160, 90],
        'left parietal': [90, 100, 110, 95, 80, 90],
        'right temporal': [155, 115, 105, 110, 165, 105],
        'left temporal': [85, 115, 105, 110, 75, 105],
        'right occipital': [155, 125, 135, 130, 165, 120],  // occipital is on right in sagittal
        'left occipital': [85, 125, 135, 130, 75, 120],
        'sphenoid wing': [130, 105, 95, 100, 135, 100],
        'greater sphenoid wing': [135, 105, 95, 100, 140, 100],
        'cerebellum': [120, 145, 145, 165, 120, 165],  // cerebellum moved right in sagittal
        'brainstem': [120, 155, 145, 175, 120, 175],
        'thalamus': [120, 110, 95, 110, 120, 110],
        'basal ganglia': [115, 110, 95, 105, 115, 105]
      };
      
      // Parse size (e.g., "5.4 x 5.6 x 6.7 cm" or "measures 2.5 cm")
      var sizeMatch = combinedText.match(/(\d+\.?\d*)\s*x\s*(\d+\.?\d*)\s*x\s*(\d+\.?\d*)\s*cm|measures?\s+(\d+\.?\d*)\s*cm/i);
      var avgSize = 18; // default radius
      if (sizeMatch) {
        if (sizeMatch[1]) {
          var dims = [parseFloat(sizeMatch[1]), parseFloat(sizeMatch[2]), parseFloat(sizeMatch[3])];
          avgSize = Math.min(30, Math.max(10, (dims[0] + dims[1] + dims[2]) / 3 * 3)); // scale to pixels
        } else if (sizeMatch[4]) {
          avgSize = Math.min(30, Math.max(10, parseFloat(sizeMatch[4]) * 3));
        }
      }
      
      // Find best location match
      var bestMatch = null;
      var bestLength = 0;
      for (var loc in locationMap) {
        if (combinedText.indexOf(loc) !== -1 && loc.length > bestLength) {
          bestMatch = loc;
          bestLength = loc.length;
        }
      }
      
      return {
        location: bestMatch,
        coords: bestMatch ? locationMap[bestMatch] : [145, 95, 135, 90, 155, 85],
        size: avgSize,
        found: !!bestMatch
      };
    }
    
    /* Update brain diagrams with parsed lesion data */
    function updateBrainDiagrams() {
      var lesionData = parseBrainLesion();
      var diagrams = document.querySelectorAll('.brain-view svg');
      
      if (diagrams.length === 3) {
        // Axial (top) view
        var axialLesion = diagrams[0].querySelector('.brain-highlight');
        if (axialLesion) {
          axialLesion.setAttribute('cx', lesionData.coords[0]);
          axialLesion.setAttribute('cy', lesionData.coords[1]);
          axialLesion.setAttribute('rx', lesionData.size);
          axialLesion.setAttribute('ry', lesionData.size * 1.2);
        }
        
        // Sagittal (side) view
        var sagittalLesion = diagrams[1].querySelector('.brain-highlight');
        if (sagittalLesion) {
          sagittalLesion.setAttribute('cx', lesionData.coords[2]);
          sagittalLesion.setAttribute('cy', lesionData.coords[3]);
          sagittalLesion.setAttribute('rx', lesionData.size * 0.9);
          sagittalLesion.setAttribute('ry', lesionData.size * 1.1);
        }
        
        // Coronal (front) view
        var coronalLesion = diagrams[2].querySelector('.brain-highlight');
        if (coronalLesion) {
          coronalLesion.setAttribute('cx', lesionData.coords[4]);
          coronalLesion.setAttribute('cy', lesionData.coords[5]);
          coronalLesion.setAttribute('rx', lesionData.size * 0.95);
          coronalLesion.setAttribute('ry', lesionData.size * 1.1);
        }
        
        // Update notes if location was found
        if (lesionData.found) {
          var notesList = document.querySelector('.brain-notes');
          if (notesList) {
            var firstNote = notesList.querySelector('li');
            if (firstNote) {
              firstNote.textContent = 'The red area indicates a lesion in the ' + lesionData.location + ' region, as described in the conclusion.';
            }
          }
        }
      }
    }
    
    // Run brain diagram updates after DOM is ready
    if (document.querySelector('.brain-visual-section')) {
      updateBrainDiagrams();
    }

    /* Term definitions */
    var TERM_DEFS = {
      "interhemispheric fissure":"deep groove between the two brain halves",
      "cortical sulcation":"normal folds and grooves on the brain surface",
      "grey-white matter differentiation":"normal contrast between outer (grey) and inner (white) layers",
      "cerebral ventricles":"fluid spaces inside the brain",
      "ventricles":"fluid spaces inside the brain",
      "basal cisterns":"fluid spaces at the base of the brain",
      "posterior fossa":"back lower part of the skull that holds cerebellum and brainstem",
      "brain stem":"part that connects the brain to the spinal cord",
      "brainstem":"part that connects the brain to the spinal cord",
      "sella":"small bone pocket under the brain that holds the pituitary",
      "pituitary":"small hormone gland under the brain",
      "orbits":"eye sockets",
      "paranasal sinuses":"air pockets in the face",
      "sinuses":"air pockets in the face",
      "dural venous sinuses":"large veins that drain blood from the brain",
      "flow voids":"MRI signs of fast-moving blood",
      "craniocervical junction":"where the skull meets the neck",
      "intracranial space-occupying lesion":"a mass inside the skull",
      "space-occupying lesion":"a mass inside the skull"
    };
    function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
    function annotateSimpleOutputTerms(){
      var roots = document.querySelectorAll('.simple-output');
      if(!roots.length) return;
      var terms = Object.keys(TERM_DEFS);
      if(!terms.length) return;
      var pattern = '\\b(' + terms.map(escapeRegExp).join('|') + ')\\b';
      var rxCheck = new RegExp(pattern,'i');
      var rxAll = new RegExp(pattern,'gi');
      roots.forEach(function(root){
        var walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, {
          acceptNode:function(node){
            if(!node.nodeValue) return NodeFilter.FILTER_REJECT;
            rxCheck.lastIndex = 0;
            if(!rxCheck.test(node.nodeValue)) return NodeFilter.FILTER_REJECT;
            if(node.parentElement && node.parentElement.closest('[data-def]')) return NodeFilter.FILTER_REJECT;
            return NodeFilter.FILTER_ACCEPT;
          }
        });
        var toWrap = [];
        while(walker.nextNode()) toWrap.push(walker.currentNode);
        toWrap.forEach(function(textNode){
          var text = textNode.nodeValue;
          var frag = document.createDocumentFragment();
          var last = 0;
          text.replace(rxAll, function(match, _g1, offset){
            if(offset > last) frag.appendChild(document.createTextNode(text.slice(last, offset)));
            var span = document.createElement('span');
            span.textContent = match;
            span.setAttribute('data-def', TERM_DEFS[match.toLowerCase()] || 'Definition not available.');
            frag.appendChild(span);
            last = offset + match.length;
            return match;
          });
          if(last < text.length) frag.appendChild(document.createTextNode(text.slice(last)));
          if(textNode.parentNode) textNode.parentNode.replaceChild(frag, textNode);
        });
      });
    }

    /* Tooltip */
    var tooltip = document.getElementById('def-tooltip');
    function showTip(text, x, y){
      tooltip.textContent = text;
      tooltip.style.left = x + 'px';
      tooltip.style.top = y + 'px';
      tooltip.classList.remove('hidden');
      tooltip.setAttribute('aria-hidden','false');
    }
    function hideTip(){
      tooltip.classList.add('hidden');
      tooltip.setAttribute('aria-hidden','true');
    }
    document.body.addEventListener('mousemove', function(e){
      if(!tooltip.classList.contains('hidden')){
        tooltip.style.left = e.clientX + 'px';
        tooltip.style.top = (e.clientY - 14) + 'px';
      }
    }, {passive:true});
    document.addEventListener('mouseover', function(e){
      var target = e.target.closest('.simple-output [data-def]');
      if(target){
        var def = target.getAttribute('data-def') || 'Definition not available.';
        var rect = target.getBoundingClientRect();
        showTip(def, rect.left + (rect.width/2), rect.top - 6);
      }
    }, {passive:true});
    document.addEventListener('mouseout', function(e){
      var target = e.target.closest('.simple-output [data-def]');
      if(target) hideTip();
    }, {passive:true});

  annotateSimpleOutputTerms();
  applyOrganFocus(organFocus);

    /* Modal controls */
    var organModal = document.getElementById('organ-modal');
    var organClose = document.getElementById('organ-close');
    var organName = document.getElementById('organ-name');
    function openOrgan(org){
      organName.textContent = org;
      organModal.classList.add('show');
      organModal.setAttribute('aria-hidden','false');
      window.dispatchEvent(new CustomEvent('organ:open', { detail:{ organ:org } }));
    }
    function closeOrgan(){
      organModal.classList.remove('show');
      organModal.setAttribute('aria-hidden','true');
    }
    if(organClose) organClose.addEventListener('click', closeOrgan);
    organModal.addEventListener('click', function(e){ if(e.target === organModal) closeOrgan(); });
    document.addEventListener('click', function(e){
      var o = e.target.closest('.organ-link');
      if(o){
        var key = o.getAttribute('data-organ') || o.textContent.trim().toLowerCase();
        openOrgan(key);
      }
    });
  });

  function applyOrganFocus(focus){
    if(!focus || !focus.organ) return;
    if(focus.organ === 'lung') updateLungDiagrams(focus);
    if(focus.organ === 'liver') updateLiverDiagrams(focus);
    if(focus.organ === 'kidney') updateKidneyDiagrams(focus);
    if(focus.organ === 'spine') updateSpineDiagrams(focus);
  }

  function updateLungDiagrams(focus){
    var section = document.querySelector('.organ-visual-section[data-organ="lung"]');
    if(!section) return;
    var laterality = focus.laterality || 'right';
    var zone = focus.zone || '';
    var axial = section.querySelector('.brain-view:nth-child(1) .brain-highlight');
    if(axial){
      var cx = laterality === 'left' ? 95 : laterality === 'bilateral' ? 120 : 145;
      var cy = zone === 'upper' ? 100 : zone === 'lower' ? 140 : 115;
      var radius = laterality === 'bilateral' ? 28 : 14;
      axial.setAttribute('cx', cx);
      axial.setAttribute('cy', cy);
      axial.setAttribute('r', radius);
    }
    var sagittal = section.querySelector('.brain-view:nth-child(2) .brain-highlight');
    if(sagittal){
      var sagCy = zone === 'upper' ? 105 : zone === 'lower' ? 145 : 125;
      sagittal.setAttribute('cy', sagCy);
      sagittal.setAttribute('rx', laterality === 'bilateral' ? 18 : 15);
    }
    var coronal = section.querySelector('.brain-view:nth-child(3) .brain-highlight');
    if(coronal){
      var corCx = laterality === 'left' ? 85 : laterality === 'bilateral' ? 120 : 155;
      var corCy = zone === 'upper' ? 95 : zone === 'lower' ? 130 : 110;
      coronal.setAttribute('cx', corCx);
      coronal.setAttribute('cy', corCy);
      coronal.setAttribute('rx', laterality === 'bilateral' ? 24 : 14);
    }
  }

  function updateKidneyDiagrams(focus){
    var section = document.querySelector('.organ-visual-section[data-organ="kidney"]');
    if(!section) return;
    var laterality = focus.laterality || 'right';
    var zone = focus.zone || '';
    var axial = section.querySelector('.brain-view:nth-child(1) .brain-highlight');
    if(axial){
      var axialCxMap = {left: 80, right: 160, bilateral: 120};
      var cx = axialCxMap[laterality] || 160;
      var cy = zone === 'upper' ? 108 : zone === 'lower' ? 135 : 120;
      var r = laterality === 'bilateral' ? 24 : 10;
      axial.setAttribute('cx', cx);
      axial.setAttribute('cy', cy);
      axial.setAttribute('r', r);
    }
    var sagittal = section.querySelector('.brain-view:nth-child(2) .brain-highlight');
    if(sagittal){
      var sagCy = zone === 'upper' ? 110 : zone === 'lower' ? 138 : 125;
      sagittal.setAttribute('cy', sagCy);
      sagittal.setAttribute('rx', laterality === 'bilateral' ? 14 : 8);
      sagittal.setAttribute('cx', laterality === 'left' ? 102 : 108);
    }
    var coronal = section.querySelector('.brain-view:nth-child(3) .brain-highlight');
    if(coronal){
      var corCxMap = {left: 80, right: 160, bilateral: 120};
      var corCx = corCxMap[laterality] || 160;
      var corCy = zone === 'upper' ? 100 : zone === 'lower' ? 132 : 110;
      coronal.setAttribute('cx', corCx);
      coronal.setAttribute('cy', corCy);
      coronal.setAttribute('rx', laterality === 'bilateral' ? 22 : 7);
    }
  }

  function updateLiverDiagrams(focus){
    var section = document.querySelector('.organ-visual-section[data-organ="liver"]');
    if(!section) return;
    var laterality = focus.laterality || focus.segment_group || 'right';
    var axial = section.querySelector('.brain-view:nth-child(1) .brain-highlight');
    if(axial){
      var cx = laterality === 'left' ? 105 : laterality === 'bilateral' ? 125 : laterality === 'caudate' ? 120 : 145;
      axial.setAttribute('cx', cx);
      axial.setAttribute('r', laterality === 'bilateral' ? 22 : 13);
    }
    var sagittal = section.querySelector('.brain-view:nth-child(2) .brain-highlight');
    if(sagittal){
      sagittal.setAttribute('cx', laterality === 'left' ? 110 : laterality === 'caudate' ? 122 : 135);
      sagittal.setAttribute('cy', laterality === 'caudate' ? 120 : 110);
      sagittal.setAttribute('rx', laterality === 'bilateral' ? 18 : 12);
    }
    var coronal = section.querySelector('.brain-view:nth-child(3) .brain-highlight');
    if(coronal){
      var corCx = laterality === 'left' ? 105 : laterality === 'bilateral' ? 125 : laterality === 'caudate' ? 120 : 150;
      coronal.setAttribute('cx', corCx);
      coronal.setAttribute('rx', laterality === 'bilateral' ? 20 : 12);
    }
  }

  function updateSpineDiagrams(focus){
    var section = document.querySelector('.organ-visual-section[data-organ="spine"]');
    if(!section) return;
    var region = (focus.region || '').toLowerCase();
    var axial = section.querySelector('.brain-view:nth-child(1) .brain-highlight');
    var sagittal = section.querySelector('.brain-view:nth-child(2) .brain-highlight');
    var coronal = section.querySelector('.brain-view:nth-child(3) .brain-highlight');
    var axialCyMap = {cervical: 90, thoracic: 120, lumbar: 150, sacral: 170};
    var sagittalCyMap = {cervical: 85, thoracic: 120, lumbar: 155, sacral: 175};
    var coronalYMap = {cervical: 70, thoracic: 110, lumbar: 145, sacral: 165};
    if(!region && Array.isArray(focus.levels) && focus.levels.length){
      var firstLevel = String(focus.levels[0] || '').trim();
      if(firstLevel){
        var code = firstLevel[0].toLowerCase();
        region = {c: 'cervical', t: 'thoracic', l: 'lumbar', s: 'sacral'}[code] || '';
      }
    }
    var regionKey = region || 'thoracic';
    if(axial){
      axial.setAttribute('cy', axialCyMap[regionKey] || 120);
    }
    if(sagittal){
      var sagCy = sagittalCyMap[regionKey] || 120;
      sagittal.setAttribute('cy', sagCy);
    }
    if(coronal){
      var corY = coronalYMap[regionKey] || 110;
      coronal.setAttribute('y', corY);
    }
  }
</script>

<script src="{{ url_for('static', filename='theme.js') }}"></script>
<script src="{{ url_for('static', filename='loader.js') }}"></script>
</body>
</html>
